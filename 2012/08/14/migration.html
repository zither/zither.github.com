
<!doctype html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>数据库迁移 Migrations | 槐花九九</title>
  <meta name="author" content="MiniMee" />
  <link href="/atom.xml" rel="alternate" title="Tom Preston-Werner" type="application/atom+xml" />
  <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" type="text/css" href="/css/highlight/99_solarized_dark.css" />
  <script src="/js/highlight.pack.js"></script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-33950131-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</head>
<body>
  <div class="site">
    <div class="title">
        <a href="/">槐花九九</a>
        <a class="extra" href="/archive.html">存档</a>
    </div>
    
    
    <div id="post">
    <h1>数据库迁移 Migrations</h1>
    <p class="meta">14 Aug 2012 - By MiniMee</p>

<p>在<a href="http://blog.minimee.org/2012/08/05/Artisan.html">命令行工具Artisan</a>中曾提到过Migrations，如果你熟悉Rails，那么对迁移肯定不会陌生。</p>

<p>Laravel框架为我们也提供了Migrate，打开laravel/cli/tasks/migrate/migrator.php文件我们可以看到Laravel提供的所有方法。</p>

<pre><code>install/make/migrate/rollback/reset
</code></pre>

<p>我们可以使用的大概就这五个：install初始化migrate，make用来创建任务，migrate执行任务，rollback回滚上一个任务，reset回滚所有任务。</p>

<p>前三个都非常直白，后两个是用来做回滚操作的。初始化migrate的时候会自动生成一张laravel_migrations表，其中有三个字段bundle、name和batch。</p>

<p>以<a href="http://blog.minimee.org/2012/08/05/Artisan.html">命令行工具Artisan</a>文章写的为例，我们创建了一个users表，那么migrate就会在laravel_migrations表中查入一条数据，bundle为application，name是creat_users_table任务的名字，batch为任务批次。因为我们只用mirage创建过一张users表，因此此时laravel_migrations表中的batch为1。此后任务的batch会递增，相当于任务的序号。</p>

<p>现在我们可以执行命令：</p>

<pre><code>php artisan migrate:rollback
</code></pre>

<p>执行完之后我们会发现之前建立的users表被删除了，同时laravel_migrations表中关于users表的数据也删除了。你肯定已经猜到了mirage回滚的运行方式。</p>

<p>之前建立的users表之所会被删除，是因为回滚时执行了我们在任务的down()方法中填写的命令：</p>

<pre><code>Schema::drop('users');
</code></pre>

<p>需要我们注意到是，如果没有在down()方法中加上上面的命令，在回滚的时候migrate只会删除laravel_migrations表中的记录。users表依然会保存在数据库中，那当我们再次使用migrate方法时就会提示错误，因为users表已经存在了。</p>

<p>migrate的rollback只回滚最后一次任务，也就是laravel_migrations表中batch批次最大的任务，而reset操作则会回滚所有任务。</p>

<p>我们来拓展下，Laravel中的migrate在任务中为我们提供了up和down两种方法，其中up方法会在执行迁移时运行，而down方法则是在回滚时运行。在框架的文档中只告诉我们可以用它来创建表和删除表，其实我们可以用它来做更多的事情，比如修改表，插入记录等等。</p>

<p>我们用插入记录来举个例子，我们用artisan工具新建一个任务，取名为update_users_table:</p>

<pre><code>php artsian migrate:make update_users_table
</code></pre>

<p>我们为up方法和down方法分别添加对应的任务：</p>

<pre><code>public function up()
{
     DB::table('users')-&gt;insert(array(
                        'username'=&gt;'test',
                        'password'=&gt;Hash::make('654321'),
                        'name'=&gt;'test'
                    ));
}
public function down()
{
     DB::table('users')-&gt;where('username','=','test')-&gt;delete();
}
</code></pre>

<p>然后我们运行命令：</p>

<pre><code>php artisan migrate
</code></pre>

<p>打开数据库我们可以看到，migrate执行了我们在up方法中写的命令，往users表中插入了一行数据。那让我们回滚一下试试：</p>

<pre><code>php artisan migrate:rollback
</code></pre>

<p>不出意外的话，你会发现我们刚才插入数据不见了，因为执行了我们在down方法中填写的删除数据命令。</p>

<p>最后我们总结下，migrations任务中的up和down方法对应了migrate的执行和回滚操作，我们可以用它来执行大多数对数据库的操作命令，并且可以随时回滚，纠正错误。</p>
    </div>

    <div id="related">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'minimee'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            

    </div>

    
    <div class="footer"></div>
  </div>
  <a href="http://github.com/zither"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>
  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
