<!DOCTYPE HTML>
<html lang="zh_CN">
    <head>
        <meta charset="utf-8">
<title>使用 PHP 实现简单的 SOCKS server</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ZJmee 的代码幻境。">
<meta name="author" content="ZJmee">
<meta name="generator" content="Spress" />

        <meta name="twitter:card" content="summary">
        <meta name="twitter:image" content="/assets/img/logo.png">
    <meta name="twitter:title" content="使用 PHP 实现简单的 SOCKS server">
    <meta name="twitter:description" content="ZJmee 的代码幻境。">
    <meta name="twitter:creator" content="@ilorn">

<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 PHP 实现简单的 SOCKS server">
<meta property="og:description" content="ZJmee 的代码幻境。">
<meta property="og:url" content="/2015/02/10/implementing-socks-server-in-php.html">
<meta property="og:site_name" content="ZJMEE 机械迷城">

<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="ZJMEE 机械迷城 Feed">
<link rel="icon" type="image/png" href="/assets/img/logo.png">
<link rel="apple-touch-icon" href="/assets/img/logo.png">


<link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href="//cdn.staticfile.org/twitter-bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="/assets/css/style.css" rel="stylesheet" media="screen">

<link rel="stylesheet" href="/assets/css/obsidian.css">
    </head>
    <body>
        <div id="wrap">
            <div class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand">
            <a class="label label-primary" href="/">ZJMEE 机械迷城</a>
        </div>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
        <li><a href="/">
        Home</a>
    </li>
        <li><a href="/linux">
        Linux</a>
    </li>
    </ul>
      </div><!--/.nav-collapse -->
    </div>
</div>
            <div class="container">
                    <article class="post">
    <header>
        <h1>
            <a href="/2015/02/10/implementing-socks-server-in-php.html">使用 PHP 实现简单的 SOCKS server</a>
        </h1>
    </header>
    
    <p>SOCKS 协议是一个比较好玩的协议，通过它我们可以突破一些限制访问原本无法访问的资源，就比如最近很火的 ss 代理。SOCKS 协议本身的规范很短，这里就不多做介绍，请戳这里：<a href="https://www.ietf.org/rfc/rfc1928.txt">RFC-1928</a>。在这篇文章里我们将使用 PHP 来实现一个简单无验证的 SOCKS5 server。</p>

<p>首先我们需要监听一个本地端口来转发对应的数据，在 PHP5 之后我们可以使用 <code>stream_socket_*</code> 系列函数来实现：</p>

<pre><code class="php">set_time_limit(0);

$master = stream_socket_server("tcp://127.0.0.1:5250", $errno, $errstr);
if (false === $master) {
    throw new Exception($errstr, $errno);
}

while (true) {
    $socket = @stream_socket_accept($master);
    if (false === $socket) {
        continue;
    }
    // do something
}
fclose($master);
</code></pre>

<p>在这段代码里我们创建了一个 TCP socket 对本地的 5250 端口进行监听，并在无限循环中不断检查是否有新的连接。这里我没有设置 <code>stream_socket_accept</code> 的 timeout，并抑制了超时错误提示。这样一个阻塞版的基本架子我们就搭建好了，下面我们需要实现 SOCKS server 与客户端协商的部分。</p>

<p>为了方便测试，我们将浏览器的代理设置为 SOCKS5，地址设置为本地监听地址。当客户端连接到我们的 SOCKS server 时会先发出一个3字节的验证请求，请求报文包括 VER，NMETHODS 以及 METHODS。VER 就是 SOCKS 版本号（version），NMETHODS 为 METHODS 的字节长度，METHODS 就是验证方法的代号。</p>

<p>我们写代码来看下浏览器连接 server 时发送的验证请求报文内容：</p>

<pre><code class="php">while (true) {
    $socket = @stream_socket_accept($master);
    if (false === $socket) {
        continue;
    }
    $data = stream_socket_recvfrom($socket, 1500);
    if ("" === $data || false === $data || strlen($data) &lt; 3) {
        fclose($socket);
        continue;
    }
    var_dump(unpack("CVER/CNMETHODS/CMETHODS", $data));exit;
}
</code></pre>

<p>当我们通过浏览器访问网站的时候，会看到以下结果：</p>

<pre><code class="php">array(3) {
    ["VER"] =&gt; int(5)
    ["NMETHODS"] =&gt; int(1)
    ["METHODS"] =&gt; int(0)
}
</code></pre>

<p><code>stream_socket_recvfrom</code> 收到的数据是二进制，我们 unpack 了前3个字节，看到的结果是 0x05 0x01 0x00。0x05 表明浏览器接受 SOCKS 代理的版本为5（0x05），验证方法的字节长度为1（0x01），方法代号为0（0x00）。请求报文正合我们的要求，我们可以直接回复这个请求：</p>

<pre><code class="php">fwrite($socket, pack("C2", 0x05, 0x00));
</code></pre>

<p>从 SOCKS 规范中可以看到，0x00 标示不需要权限验证（X'00' NO AUTHENTICATION REQUIRED）。到这里我们完成了第一次协商，为了方便，我们要直接跳过验证请求部分。如果你需要实现验证环节，比如 Username/Password 验证，可以直接参考 <a href="https://tools.ietf.org/html/rfc1929">RFC 1929</a>。</p>

    
        <footer>    
        <p class="pubdate">
        	Posted by ZJmee on <time pubdate="pubdate">2015-02-10</time>
        </p>
    </footer>
        
                </article>
            </div>
        </div>
            
        <footer id="footer">
            <div class="container">
                <div class="row">
                    <div class="col-xs-6">
                        <ul class="list-inline">
        <li><a href="/about">
        About</a>
    </li>
        <li><a href="http://www.shouhuiben.com">
        Shouhuiben</a>
    </li>
        <li><a href="https://github.com/yosymfony/Spress-theme-spresso">
        Spresso</a>
    </li>
    </ul>
                    </div>
                    <div class="col-xs-6 text-right">
                        <ul class="list-inline">
        <li>
        <a href="https://twitter.com/ilorn">
            <i class="fa fa-twitter fa-2x"></i>
        </a>
    </li>
        
        
        
        
        <li>
        <a href="https://github.com/zither">
            <i class="fa fa-github fa-2x"></i>
        </a>
    </li>
        
        
    </ul>                    </div>
                </div>
                <p class="text-center">
                    &copy; 2014 - 2015 ZJmee.
                    Powered by <a href="http://spress.yosymfony.com">Spress</a>.
                </p>
            </div>
            <script src="//cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
            <script src="//cdn.staticfile.org/twitter-bootstrap/3.0.0/js/bootstrap.min.js"></script>
            
                        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
            <script>hljs.initHighlightingOnLoad();</script>
                        
                        </footer>
    </body>
</html>
